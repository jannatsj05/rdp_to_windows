name: Gi123

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 9999

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Enable RDP
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)

      # ✅ Download from official GitHub Releases
      - name: Download LocalXpose CLI (latest)
        shell: powershell
        run: |
          $url = "https://github.com/localxpose/cli/releases/latest/download/loclx-windows-amd64.zip"
          Write-Host "Downloading LocalXpose from $url ..."
          Invoke-WebRequest -Uri $url -OutFile "loclx.zip"
          Expand-Archive loclx.zip -DestinationPath .
          Rename-Item ".\loclx-windows-amd64.exe" "loclx.exe"
          Write-Host "Download complete. Checking version..."
          .\loclx.exe --version

      # ✅ Login with your LocalXpose token (GitHub secret)
      - name: Login to LocalXpose
        shell: powershell
        env:
          LOCLX_TOKEN: ${{ secrets.LOCLX_TOKEN }}
        run: |
          if (-not $Env:LOCLX_TOKEN) {
            Write-Error "LOCLX_TOKEN secret missing! Add it in GitHub → Settings → Secrets → Actions"
            exit 1
          }
          .\loclx.exe account login $Env:LOCLX_TOKEN

      # ✅ Start TCP tunnel in background
      - name: Start LocalXpose TCP tunnel
        shell: powershell
        run: |
          Write-Host "Starting LocalXpose TCP tunnel..."
          Start-Process -FilePath ".\loclx.exe" -ArgumentList "tunnel tcp --to 3389" -NoNewWindow
          Start-Sleep -Seconds 6
          Write-Host "Tunnel started. Check log for endpoint info."

      - name: Run upload.bat
        shell: cmd
        run: echo "Upload step running..."
