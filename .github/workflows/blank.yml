name: Gi123

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 9999

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Enable RDP
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)

      # ✅ Download loclx.exe directly (no npm)
      - name: Download LocalXpose CLI
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://localxpose.io/cli/windows_amd64.zip" -OutFile "loclx.zip"
          Expand-Archive loclx.zip -DestinationPath .
          dir .

      # ✅ Login using your token (use secrets for safety)
      - name: Login LocalXpose
        shell: powershell
        env:
          LOCLX_TOKEN: ${{ secrets.LOCLX_TOKEN }}
        run: |
          if (-not $Env:LOCLX_TOKEN) {
            Write-Error "LOCLX_TOKEN secret missing! Add it in GitHub -> Settings -> Secrets -> Actions"
            exit 1
          }
          .\loclx.exe account login $Env:LOCLX_TOKEN

      # ✅ Start TCP tunnel in background
      - name: Start LocalXpose TCP tunnel
        shell: powershell
        run: |
          Start-Process -FilePath ".\loclx.exe" -ArgumentList "tunnel tcp --to 3389" -NoNewWindow
          Start-Sleep -Seconds 5
          Write-Host "Tunnel started successfully!"

      - name: Run upload.bat
        shell: cmd
        run: echo "Upload step running..."
