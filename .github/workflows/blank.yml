name: RDP_with_LocalXpose_Fixed

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 9999

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Enable RDP Access
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)
          Write-Host "âœ… RDP enabled successfully."

      - name: Download LocalXpose CLI
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://api.localxpose.io/api/downloads/loclx-windows-amd64.zip" -OutFile "loclx.zip"
          Expand-Archive -Path "loclx.zip" -DestinationPath "." -Force
          Write-Host "âœ… LocalXpose (loclx.exe) extracted successfully."

      - name: Login to LocalXpose (non-interactive)
        shell: cmd
        env:
          LOCLX_TOKEN: ${{ secrets.LOCLX_TOKEN }}
        run: |
          echo %LOCLX_TOKEN% | loclx.exe account login
          REM verify login
          loclx.exe account status

      - name: Start LocalXpose Tunnel (TCP 3389)
        shell: powershell
        run: |
          Write-Host "ðŸš€ Starting tunnel for RDP (TCP 3389)..."
          Start-Process -FilePath ".\loclx.exe" -ArgumentList "tunnel tcp --to 3389" -NoNewWindow
          Write-Host "ðŸŒ Tunnel started. You can view the public address in the next step."

      - name: Keep session alive
        shell: cmd
        run: ping -t 127.0.0.1 >nul
