name: RDP_with_LocalXpose_ReservedEndpoint

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 9999

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare RDP user, enable RDP & firewall
        shell: powershell
        run: |
          $Username = "runneradmin"

          # Generate random 12-char password
          $chars = @(48..57 + 65..90 + 97..122 + 33..47 + 58..64 + 91..96)
          $pwChars = for ($i=0; $i -lt 12; $i++) { [char]($chars | Get-Random) }
          $PlainPassword = -join $pwChars

          # Create/update user
          if (-not (Get-LocalUser -Name $Username -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $Username -Password (ConvertTo-SecureString $PlainPassword -AsPlainText -Force) -PasswordNeverExpires $true
          } else {
              Set-LocalUser -Name $Username -Password (ConvertTo-SecureString $PlainPassword -AsPlainText -Force)
          }

          # Add to groups
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $Username -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Administrators" -Member $Username -ErrorAction SilentlyContinue

          # Enable RDP and firewall
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # Show credentials
          Write-Host "----- RDP CREDENTIALS -----"
          Write-Host "Username: $Username"
          Write-Host "Password: $PlainPassword"
          Write-Host "---------------------------"

      - name: Download LocalXpose CLI
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://api.localxpose.io/api/downloads/loclx-windows-amd64.zip" -OutFile "loclx.zip" -UseBasicParsing
          Expand-Archive -Path "loclx.zip" -DestinationPath "." -Force

      - name: Ensure LocalXpose session
        shell: powershell
        run: |
          $sessionFile = "$env:USERPROFILE\.localxpose\session.json"
          if (-not (Test-Path $sessionFile)) {
              Write-Warning "No saved session found. Please login once manually via GUI to save session."
          }

      - name: Reserve endpoint (if not already)
        shell: powershell
        run: |
          # Set a fixed endpoint for RDP
          $reservedEndpoint = "us.loclx.io:4455"  # change region/port as needed
          
          # Reserve if not already
          $check = & .\loclx.exe endpoint list 2>&1 | Select-String -Pattern $reservedEndpoint
          if (-not $check) {
              Write-Host "Reserving endpoint $reservedEndpoint..."
              & .\loclx.exe endpoint reserve --reserved-endpoint $reservedEndpoint
          } else {
              Write-Host "Endpoint $reservedEndpoint already reserved."
          }

      - name: Start LocalXpose Tunnel (TCP 3389 with reserved endpoint)
        shell: powershell
        run: |
          $reservedEndpoint = "us.loclx.io:4455"
          $arg = "tunnel tcp --reserved-endpoint $reservedEndpoint --to 127.0.0.1:3389"
          $proc = Start-Process -FilePath ".\loclx.exe" -ArgumentList $arg -WindowStyle Hidden -PassThru
          Start-Sleep -Seconds 6

          Write-Host "Public RDP address: $reservedEndpoint"
          Write-Host "LocalXpose process id: $($proc.Id)"

      - name: Keep session alive
        shell: cmd
        run: ping -t 127.0.0.1 >nul
