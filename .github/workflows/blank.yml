name: RDP_with_LocalXpose

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 9999

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Enable RDP Access
        shell: powershell
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)
          Write-Host "âœ… RDP enabled successfully."

      - name: Download LocalXpose CLI
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://api.localxpose.io/api/downloads/loclx-windows-amd64.zip" -OutFile "loclx.zip"
          Expand-Archive loclx.zip -DestinationPath .
          Rename-Item ".\loclx-windows-amd64.exe" "loclx.exe" -Force
          Write-Host "âœ… LocalXpose downloaded successfully."

      - name: Login to LocalXpose
        shell: powershell
        env:
          LOCXLX_TOKEN: ${{ secrets.LOCLX_TOKEN }}
        run: |
          .\loclx.exe account login --token $Env:LOCXLX_TOKEN
          Write-Host "âœ… Logged in to LocalXpose successfully."

      - name: Start LocalXpose Tunnel (TCP 3389)
        shell: powershell
        run: |
          Start-Process -FilePath ".\loclx.exe" -ArgumentList "tunnel tcp --to 3389" -NoNewWindow
          Write-Host "ðŸš€ Tunnel started. Youâ€™ll get your public TCP address below."

      - name: Keep session alive
        shell: cmd
        run: ping -t 127.0.0.1 >nul
